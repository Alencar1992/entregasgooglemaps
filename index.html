<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alencas Frete - Oficial</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; background: #f0f2f5; }
        #app-container { display: flex; flex: 1; height: 100%; }
        #sidebar { width: 420px; background: white; padding: 25px; overflow-y: auto; box-shadow: 2px 0 15px rgba(0,0,0,0.1); z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        h1 { color: #1a73e8; margin: 0; font-size: 24px; font-weight: 800; border-bottom: 2px solid #f1f3f4; padding-bottom: 10px; text-align: center; }
        .info-box { background: #e8f0fe; border-left: 5px solid #1a73e8; padding: 12px; font-size: 13px; color: #1967d2; border-radius: 4px; }
        label { display: block; margin-top: 8px; font-weight: 600; color: #3c4043; font-size: 12px; text-transform: uppercase; }
        input, textarea { width: 100%; padding: 10px; margin-top: 4px; border: 1px solid #dadce0; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; text-transform: uppercase; transition: 0.2s; }
        .btn-calc { background-color: #1a73e8; color: white; }
        .btn-clear { background-color: #f1f3f4; color: #3c4043; }
        
        #result-area { margin-top: 20px; padding: 20px; background: #e6fffa; border: 1px solid #b2f5ea; border-radius: 8px; display: none; }
        #btn-whatsapp { margin-top: 15px; width: 100%; background-color: #25D366; color: white; padding: 16px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }

        /* Estilo do Modal de Erro */
        #modal-erro { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; }
        .btn-send-manual { background: #25D366; color: white; margin-top: 15px; }

        #map { flex: 1; z-index: 1; }
        @media (max-width: 768px) { #app-container { flex-direction: column-reverse; } #sidebar { width: 100%; } #map { height: 30vh; } }
    </style>
</head>
<body>

<div id="modal-erro">
    <div class="modal-content">
        <h3>üìç Endere√ßo n√£o encontrado</h3>
        <p style="font-size: 14px; color: #666;">N√£o conseguimos localizar o ponto no mapa automaticamente. Por favor, descreva o endere√ßo abaixo:</p>
        <textarea id="manual-address" rows="3" placeholder="Ex: Rua Tal, n¬∫ 10, pr√≥ximo ao mercado X..."></textarea>
        <button class="btn-send-manual" onclick="enviarManual()">Enviar para Alencar via WhatsApp</button>
        <button class="btn-clear" style="margin-top: 10px; width: 100%;" onclick="fecharModal()">Cancelar</button>
    </div>
</div>

<div id="app-container">
    <div id="sidebar">
        <h1>ALENCAS FRETE</h1>
        <div class="info-box">
            üõµ <strong>Origem:</strong> Av. Jo√£o Dias, 2074 - Santo Amaro<br>
            üí∞ <strong>M√≠nimo:</strong> R$ 5,00 | <strong>KM:</strong> R$ 1,90
        </div>

        <form id="frete-form" onsubmit="validarEProcessar(event)">
            <label>Nome Completo do Cliente *</label>
            <input type="text" id="nome" required>
            <div style="display:flex; gap:10px">
                <div style="flex:1"><label>Data *</label><input type="date" id="data" required></div>
                <div style="flex:1"><label>Hora *</label><input type="time" id="hora" required></div>
            </div>
            <div style="display:flex; gap:10px">
                <div style="flex:1"><label>CEP *</label><input type="text" id="cep" maxlength="8" onblur="buscarCEP(this.value)" required></div>
                <div style="flex:0.5"><label>N¬∫ *</label><input type="text" id="numero" required></div>
            </div>
            <label>Rua *</label><input type="text" id="rua" required>
            <div style="display:flex; gap:10px">
                <div style="flex:1"><label>Bairro *</label><input type="text" id="bairro" required></div>
                <div style="flex:1"><label>Cidade *</label><input type="text" id="cidade" required></div>
            </div>
            <div class="btn-group">
                <button type="button" class="btn-clear" onclick="location.reload()">Limpar</button>
                <button type="submit" class="btn-calc">Calcular Frete</button>
            </div>
        </form>

        <div id="result-area">
            <div style="text-align:center">
                <span id="res-dist"></span> | <span id="res-tempo"></span>
                <div class="total-price" id="res-valor"></div>
            </div>
            <button id="btn-whatsapp" onclick="enviar()">Enviar para Alencar</button>
        </div>
    </div>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
    const LAT_ORIGEM = -23.644629547444527, LNG_ORIGEM = -46.720383237596;
    const VALOR_KM = 1.90, FRETE_MINIMO = 5.00, WHATSAPP = "551981071822"; 
    let map, routingControl, vFinal = 0, dFinal = "";

    window.onload = () => {
        map = L.map('map').setView([LAT_ORIGEM, LNG_ORIGEM], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.marker([LAT_ORIGEM, LNG_ORIGEM]).addTo(map).bindPopup("Origem").openPopup();
        document.getElementById('data').value = new Date().toISOString().split('T')[0];
    };

    function buscarCEP(valor) {
        const cep = valor.replace(/\D/g, '');
        if (cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`).then(r => r.json()).then(d => {
                if (!d.erro) {
                    document.getElementById('rua').value = d.logradouro;
                    document.getElementById('bairro').value = d.bairro;
                    document.getElementById('cidade').value = d.localidade;
                }
            });
        }
    }

    async function validarEProcessar(e) {
        e.preventDefault();
        const cep = document.getElementById('cep').value;
        try {
            const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&postalcode=${cep}&country=Brazil&limit=1`);
            const data = await resp.json();
            if (data.length > 0) {
                calcular(data[0].lat, data[0].lon);
            } else {
                abrirModal();
            }
        } catch (err) { abrirModal(); }
    }

    function calcular(lat, lon) {
        if (routingControl) map.removeControl(routingControl);
        routingControl = L.Routing.control({
            waypoints: [L.latLng(LAT_ORIGEM, LNG_ORIGEM), L.latLng(lat, lon)],
            show: false, createMarker: () => null
        }).addTo(map);

        routingControl.on('routesfound', (e) => {
            const s = e.routes[0].summary;
            const km = (s.totalDistance / 1000).toFixed(1);
            let preco = Math.max(km * VALOR_KM, FRETE_MINIMO);
            vFinal = preco.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            dFinal = km + " km";
            document.getElementById('res-dist').innerText = dFinal;
            document.getElementById('res-tempo').innerText = Math.round(s.totalTime / 60) + " min";
            document.getElementById('res-valor').innerText = "R$ " + vFinal;
            document.getElementById('result-area').style.display = "block";
        });
    }

    function abrirModal() { document.getElementById('modal-erro').style.display = 'flex'; }
    function fecharModal() { document.getElementById('modal-erro').style.display = 'none'; }

    function enviarManual() {
        const nome = document.getElementById('nome').value || "Cliente";
        const info = document.getElementById('manual-address').value;
        if (!info) return alert("Por favor, descreva o endere√ßo.");
        
        const msg = `*ALERTA: LOCALIZA√á√ÉO MANUAL* ‚ö†Ô∏è%0A%0A` +
                    `üë§ *Cliente:* ${nome}%0A` +
                    `üìç *Endere√ßo informado:* ${info}%0A%0A` +
                    `_O site n√£o conseguiu localizar automaticamente. Favor calcular manualmente._`;
        
        window.open(`https://wa.me/${WHATSAPP}?text=${msg}`);
        alert("Sua solicita√ß√£o foi enviada! Por favor, aguarde o retorno do Alencar no WhatsApp.");
        fecharModal();
    }

    function enviar() {
        const nome = document.getElementById('nome').value;
        const endereco = `${document.getElementById('rua').value}, ${document.getElementById('numero').value} - ${document.getElementById('bairro').value}`;
        const msg = `*NOVO FRETE - ALENCAS* üõµ%0A%0Aüë§ *Cliente:* ${nome}%0Aüìè *Dist√¢ncia:* ${dFinal}%0Aüí∞ *Valor:* R$ ${vFinal}%0Aüìç *Endere√ßo:* ${endereco}`;
        window.open(`https://wa.me/${WHATSAPP}?text=${msg}`);
    }
</script>
</body>
</html>
