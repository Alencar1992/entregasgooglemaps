<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alencas Frete - Oficial</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <style>
        :root {
            --alencas-gray: #ffffff; /*muda s√≥ a lateral do app*/
            --darker-gray: #666666;
            --text-black: #000000; /*cor dos textos*/
            --alencas-blue: #0a1cc4;
            --alencas-green: #28a745; /*cor do bot√£o calcular frete*/
            --alencas-red: #dc3545; /*cor do bot√£o limpar*/
            --input-border: #05ebbd; /*borda das caixas*/
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; background: var(--alencas-gray); color: var(--text-white); }
        #app-container { display: flex; flex: 1; height: 100%; }
        
        #sidebar { 
            width: 420px; 
            background: var(--alencas-gray); 
            padding: 0; 
            overflow-y: auto; 
            box-shadow: 4px 0 15px rgba(0,0,0,0.3); 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            border-right: 1px solid var(--darker-gray);
        }

        /* CABE√áALHO ESTILIZADO */
        .sidebar-header {
            background-color: #ffffff; /* Cinza claro para destacar o t√≠tulo */
            padding: 25px 15px;
            text-align: center;
            border-bottom: 4px solid var(--alencas-blue);
        }

        .sidebar-header h1 { 
            color: var(--alencas-blue); 
            margin: 0; 
            font-family: 'Pricedown';
            font-size: 34px; 
            font-weight: 900; 
            text-transform: uppercase;
            -webkit-text-stroke: 1.2px white;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }

        .form-content {
            padding: 20px 25px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: var(--alencas-gray);
        }
        
        .info-box { background: rgba(255, 255, 255, 0.1); border-left: 5px solid var(--alencas-blue); padding: 12px; font-size: 13px; color: white; border-radius: 4px; }
        
        label { display: block; margin-top: 8px; font-weight: 700; color: #f0f0f0; font-size: 11px; text-transform: uppercase; }
        
        input, textarea { 
            width: 100%; 
            padding: 12px; 
            margin-top: 4px; 
            background: #fdfdfd; 
            border: 2px solid var(--input-border); 
            border-radius: 6px; 
            box-sizing: border-box; 
            font-size: 14px; 
            color: #333; 
            font-weight: 600;
        }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; text-transform: uppercase; color: white; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        /* BOT√ïES SOLICITADOS */
        .btn-calc { background-color: var(--alencas-green); }
        .btn-calc:hover { background-color: #218838; transform: translateY(-2px); }
        
        .btn-clear { background-color: var(--alencas-red); }
        .btn-clear:hover { background-color: #c82333; }

        #result-area { 
            margin-top: 20px; 
            padding: 20px; 
            background: #3e4d4c; 
            border: 2px solid #2d3a39; 
            border-radius: 8px; 
            display: none; 
        }

        .total-price { font-size: 36px; font-weight: 900; color: #00ffcc; text-align: center; margin-top: 10px; text-shadow: 1px 1px 2px black; }
        #btn-whatsapp { margin-top: 15px; width: 100%; background-color: #25D366; color: white; padding: 18px; border-radius: 8px; border: none; font-weight: 900; cursor: pointer; font-size: 16px; }

        /* MODAL CINZA */
        #modal-erro { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-content { background: var(--alencas-gray); color: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; border: 3px solid white; }
        
        #map { flex: 1; z-index: 1; }

        @media (max-width: 768px) { #app-container { flex-direction: column-reverse; } #sidebar { width: 100%; max-height: 80vh; } #map { height: 20vh; } }
    </style>
</head>
<body>

<div id="modal-erro">
    <div class="modal-content">
        <h3 style="color: #ffcccc; -webkit-text-stroke: 0.5px black;">üìç ENDERE√áO N√ÉO LOCALIZADO</h3>
        <p style="font-size: 14px; margin-bottom: 15px;">N√£o encontramos no mapa. Digite o endere√ßo completo ou um ponto de refer√™ncia para enviar ao Alencar:</p>
        <textarea id="manual-address" rows="3" placeholder="Ex: Rua Jo√£o Exemplo, 123, perto da farm√°cia..."></textarea>
        <button style="background: #25D366; color: white; margin-top: 15px; width: 100%;" onclick="enviarManual()">Enviar via WhatsApp</button>
        <button class="btn-clear" style="margin-top: 10px; width: 100%;" onclick="fecharModal()">Voltar e Corrigir</button>
    </div>
</div>

<div id="app-container">
    <div id="sidebar">
        <div class="sidebar-header">
            <h1>ALENCAS FRETE</h1>
        </div>

        <div class="form-content">
            <div class="info-box">
                üõµ <b>ORIGEM:</b> Av. Jo√£o Dias, 2074 - Sto Amaro<br>
                üí∞ <b>M√çNIMO:</b> R$ 5,00 | <b>KM:</b> R$ 1,90
            </div>

            <form id="frete-form" onsubmit="validarEProcessar(event)">
                <label>Nome do Cliente *</label>
                <input type="text" id="nome" placeholder="Digite seu nome" required>
                
                <div style="display:flex; gap:10px">
                    <div style="flex:1"><label>Data *</label><input type="date" id="data" required></div>
                    <div style="flex:1"><label>Hora *</label><input type="time" id="hora" required></div>
                </div>
                
                <div style="display:flex; gap:10px">
                    <div style="flex:1"><label>CEP *</label><input type="text" id="cep" maxlength="8" onblur="buscarCEP(this.value)" required placeholder="00000000"></div>
                    <div style="flex:0.5"><label>N¬∫ *</label><input type="text" id="numero" required placeholder="N¬∫"></div>
                </div>
                
                <label>Rua *</label><input type="text" id="rua" required>
                <div style="display:flex; gap:10px">
                    <div style="flex:1"><label>Bairro *</label><input type="text" id="bairro" required></div>
                    <div style="flex:1"><label>Cidade *</label><input type="text" id="cidade" required></div>
                </div>
                
                <div class="btn-group">
                    <button type="button" class="btn-clear" onclick="location.reload()">Limpar</button>
                    <button type="submit" class="btn-calc">Calcular Frete</button>
                </div>
            </form>

            <div id="result-area">
                <div style="text-align:center; padding-bottom: 10px;">
                    <span id="res-dist" style="font-weight: 900; font-size: 18px;"></span> | <span id="res-tempo"></span>
                    <div class="total-price" id="res-valor"></div>
                </div>
                <button id="btn-whatsapp" onclick="enviar()">Confirmar e Enviar Pedido</button>
            </div>
        </div>
    </div>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
    const LAT_ORIGEM = -23.644629547444527, LNG_ORIGEM = -46.720383237596;
    const VALOR_KM = 1.90, FRETE_MINIMO = 5.00, WHATSAPP = "5511981071822";
    let map, routingControl, vFinal = 0, dFinal = "";

    window.onload = () => {
        map = L.map('map', {zoomControl: true}).setView([LAT_ORIGEM, LNG_ORIGEM], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.marker([LAT_ORIGEM, LNG_ORIGEM]).addTo(map).bindPopup("Alencas Frete - Origem").openPopup();
        document.getElementById('data').value = new Date().toISOString().split('T')[0];
    };

    function buscarCEP(valor) {
        const cep = valor.replace(/\D/g, '');
        if (cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`).then(r => r.json()).then(d => {
                if (!d.erro) {
                    document.getElementById('rua').value = d.logradouro;
                    document.getElementById('bairro').value = d.bairro;
                    document.getElementById('cidade').value = d.localidade;
                }
            });
        }
    }

    async function validarEProcessar(e) {
        e.preventDefault();
        const cep = document.getElementById('cep').value;
        const rua = document.getElementById('rua').value;
        const num = document.getElementById('numero').value;
        const cidade = document.getElementById('cidade').value;

        try {
            const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&postalcode=${cep}&country=Brazil&limit=1`);
            const data = await resp.json();
            if (data.length > 0) {
                calcular(data[0].lat, data[0].lon);
            } else {
                const buscaEnd = `${rua}, ${num}, ${cidade}`;
                const respEnd = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(buscaEnd)}&limit=1`);
                const dataEnd = await respEnd.json();
                if(dataEnd.length > 0) calcular(dataEnd[0].lat, dataEnd[0].lon);
                else abrirModal();
            }
        } catch (err) { abrirModal(); }
    }

    function calcular(lat, lon) {
        if (routingControl) map.removeControl(routingControl);
        routingControl = L.Routing.control({
            waypoints: [L.latLng(LAT_ORIGEM, LNG_ORIGEM), L.latLng(lat, lon)],
            show: false,
            lineOptions: { styles: [{color: '#007bff', opacity: 1, weight: 6}] },
            createMarker: (i, wp) => i === 1 ? L.marker(wp.latLng).bindPopup("Destino") : null
        }).addTo(map);

        routingControl.on('routesfound', (e) => {
            const s = e.routes[0].summary;
            const km = (s.totalDistance / 1000).toFixed(1);
            let preco = Math.max(km * VALOR_KM, FRETE_MINIMO);
            vFinal = preco.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            dFinal = km + " km";
            document.getElementById('res-dist').innerText = dFinal;
            document.getElementById('res-tempo').innerText = Math.round(s.totalTime / 60) + " min";
            document.getElementById('res-valor').innerText = "R$ " + vFinal;
            document.getElementById('result-area').style.display = "block";
            map.flyTo([lat, lon], 14);
        });
    }

    function abrirModal() { document.getElementById('modal-erro').style.display = 'flex'; }
    function fecharModal() { document.getElementById('modal-erro').style.display = 'none'; }

    function enviarManual() {
        const info = document.getElementById('manual-address').value;
        if (!info) return alert("Descreva o endere√ßo.");
        const msg = `*ERRO LOCALIZA√á√ÉO - ALENCAS*‚ö†Ô∏è%0A%0Aüë§*Cliente:* ${document.getElementById('nome').value}%0Aüìç*End:* ${info}`;
        window.open(`https://wa.me/${WHATSAPP}?text=${msg}`);
        fecharModal();
    }

    function enviar() {
        const nome = document.getElementById('nome').value;
        const endereco = `${document.getElementById('rua').value}, ${document.getElementById('numero').value} - ${document.getElementById('bairro').value}`;
        const msg = `*PEDIDO DE FRETE* üõµ%0A%0Aüë§*Cliente:* ${nome}%0Aüìè*Dist√¢ncia:* ${dFinal}%0Aüí∞*Valor:* R$ ${vFinal}%0Aüìç*End:* ${endereco}`;
        window.open(`https://wa.me/${WHATSAPP}?text=${msg}`);
    }
</script>
</body>
</html>


