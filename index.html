<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alencas Frete - Oficial</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <style>
        :root {
            --bg-dark: #121212;
            --sidebar-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --alencas-blue: #007bff;
            --alencas-green: #28a745;
            --alencas-red: #dc3545;
            --input-bg: #2d2d2d;
            --border-color: #333333;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; background: var(--bg-dark); color: var(--text-main); }
        #app-container { display: flex; flex: 1; height: 100%; }
        
        #sidebar { 
            width: 420px; 
            background: var(--sidebar-bg); 
            padding: 25px; 
            overflow-y: auto; 
            box-shadow: 4px 0 15px rgba(0,0,0,0.5); 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            border-right: 1px solid var(--border-color);
        }
        
        /* T√çTULO COM BORDA BRANCA E FONTE AZUL */
        h1 { 
            color: var(--alencas-blue); 
            margin: 0; 
            font-size: 32px; 
            font-weight: 900; 
            text-align: center; 
            letter-spacing: 2px;
            text-transform: uppercase;
            -webkit-text-stroke: 1.5px white; /* Borda Branca */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .info-box { background: #1a2332; border-left: 5px solid var(--alencas-blue); padding: 12px; font-size: 13px; color: #8ab4f8; border-radius: 4px; margin-top: 5px;}
        
        label { display: block; margin-top: 8px; font-weight: 600; color: var(--text-muted); font-size: 11px; text-transform: uppercase; }
        
        input, textarea { 
            width: 100%; 
            padding: 12px; 
            margin-top: 4px; 
            background: var(--input-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 6px; 
            box-sizing: border-box; 
            font-size: 14px; 
            color: white; 
        }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; text-transform: uppercase; transition: 0.2s; color: white; }
        
        /* BOT√ÉO CALCULAR VERDE */
        .btn-calc { background-color: var(--alencas-green); }
        .btn-calc:hover { background-color: #218838; transform: translateY(-1px); }
        
        /* BOT√ÉO LIMPAR VERMELHO */
        .btn-clear { background-color: var(--alencas-red); }
        .btn-clear:hover { background-color: #c82333; }

        #result-area { 
            margin-top: 20px; 
            padding: 20px; 
            background: #0f2d2b; 
            border: 1px solid #1a4d49; 
            border-radius: 8px; 
            display: none; 
        }

        .total-price { font-size: 32px; font-weight: 800; color: #4fd1c5; text-align: center; margin-top: 10px; }

        #btn-whatsapp { margin-top: 15px; width: 100%; background-color: #25D366; color: white; padding: 16px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }

        #modal-erro { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: var(--sidebar-bg); color: var(--text-main); padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--border-color); }
        
        #map { flex: 1; z-index: 1; filter: invert(90%) hue-rotate(180deg) brightness(95%) contrast(90%); }

        @media (max-width: 768px) { #app-container { flex-direction: column-reverse; } #sidebar { width: 100%; max-height: 80vh; } #map { height: 20vh; } }
    </style>
</head>
<body>

<div id="modal-erro">
    <div class="modal-content">
        <h3 style="color: #f28b82;">üìç Endere√ßo n√£o encontrado</h3>
        <p style="font-size: 14px; color: var(--text-muted);">Informe o endere√ßo completo ou ponto de refer√™ncia para enviarmos ao Alencar:</p>
        <textarea id="manual-address" rows="3" placeholder="Ex: Rua Jo√£o Exemplo, 123, perto do mercado..."></textarea>
        <button style="background: #25D366; color: white; margin-top: 15px; width: 100%;" onclick="enviarManual()">Enviar via WhatsApp</button>
        <button class="btn-clear" style="margin-top: 10px; width: 100%;" onclick="fecharModal()">Voltar</button>
    </div>
</div>

<div id="app-container">
    <div id="sidebar">
        <h1>ALENCAS FRETE</h1>
        <div class="info-box">
            üõµ <strong>Origem:</strong> Av. Jo√£o Dias, 2074 - Sto Amaro<br>
            üí∞ <strong>M√≠nimo:</strong> R$ 5,00 | <strong>KM:</strong> R$ 1,90
        </div>

        <form id="frete-form" onsubmit="validarEProcessar(event)">
            <label>Nome do Cliente *</label>
            <input type="text" id="nome" placeholder="Nome completo" required>
            
            <div style="display:flex; gap:10px">
                <div style="flex:1"><label>Data *</label><input type="date" id="data" required></div>
                <div style="flex:1"><label>Hora *</label><input type="time" id="hora" required></div>
            </div>
            
            <div style="display:flex; gap:10px">
                <div style="flex:1"><label>CEP *</label><input type="text" id="cep" maxlength="8" onblur="buscarCEP(this.value)" required placeholder="00000000"></div>
                <div style="flex:0.5"><label>N¬∫ *</label><input type="text" id="numero" required placeholder="N¬∫"></div>
            </div>
            
            <label>Rua *</label><input type="text" id="rua" required>
            <div style="display:flex; gap:10px">
                <div style="flex:1"><label>Bairro *</label><input type="text" id="bairro" required></div>
                <div style="flex:1"><label>Cidade *</label><input type="text" id="cidade" required></div>
            </div>
            
            <div class="btn-group">
                <button type="button" class="btn-clear" onclick="location.reload()">Limpar</button>
                <button type="submit" class="btn-calc">Calcular Frete</button>
            </div>
        </form>

        <div id="result-area">
            <div style="text-align:center; color: var(--text-muted); border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">
                <span id="res-dist" style="color: white; font-weight: bold;"></span> | <span id="res-tempo"></span>
                <div class="total-price" id="res-valor"></div>
            </div>
            <button id="btn-whatsapp" onclick="enviar()">Confirmar Pedido</button>
        </div>
    </div>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
    const LAT_ORIGEM = -23.644629547444527, LNG_ORIGEM = -46.720383237596;
    const VALOR_KM = 1.90, FRETE_MINIMO = 5.00, WHATSAPP = "5511981071822";
    let map, routingControl, vFinal = 0, dFinal = "";

    window.onload = () => {
        map = L.map('map', {zoomControl: false}).setView([LAT_ORIGEM, LNG_ORIGEM], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.marker([LAT_ORIGEM, LNG_ORIGEM]).addTo(map);
        document.getElementById('data').value = new Date().toISOString().split('T')[0];
    };

    function buscarCEP(valor) {
        const cep = valor.replace(/\D/g, '');
        if (cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`).then(r => r.json()).then(d => {
                if (!d.erro) {
                    document.getElementById('rua').value = d.logradouro;
                    document.getElementById('bairro').value = d.bairro;
                    document.getElementById('cidade').value = d.localidade;
                }
            });
        }
    }

    async function validarEProcessar(e) {
        e.preventDefault();
        const cep = document.getElementById('cep').value;
        try {
            const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&postalcode=${cep}&country=Brazil&limit=1`);
            const data = await resp.json();
            if (data.length > 0) calcular(data[0].lat, data[0].lon);
            else abrirModal();
        } catch (err) { abrirModal(); }
    }

    function calcular(lat, lon) {
        if (routingControl) map.removeControl(routingControl);
        routingControl = L.Routing.control({
            waypoints: [L.latLng(LAT_ORIGEM, LNG_ORIGEM), L.latLng(lat, lon)],
            show: false,
            lineOptions: { styles: [{color: '#007bff', opacity: 1, weight: 6}] },
            createMarker: (i, wp) => i === 1 ? L.marker(wp.latLng).bindPopup("Destino") : null
        }).addTo(map);

        routingControl.on('routesfound', (e) => {
            const s = e.routes[0].summary;
            const km = (s.totalDistance / 1000).toFixed(1);
            let preco = Math.max(km * VALOR_KM, FRETE_MINIMO);
            vFinal = preco.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            dFinal = km + " km";
            document.getElementById('res-dist').innerText = dFinal;
            document.getElementById('res-tempo').innerText = Math.round(s.totalTime / 60) + " min";
            document.getElementById('res-valor').innerText = "R$ " + vFinal;
            document.getElementById('result-area').style.display = "block";
            map.flyTo([lat, lon], 14);
        });
    }

    function abrirModal() { document.getElementById('modal-erro').style.display = 'flex'; }
    function fecharModal() { document.getElementById('modal-erro').style.display = 'none'; }

    function enviarManual() {
        const info = document.getElementById('manual-address').value;
        if (!info) return alert("Descreva o endere√ßo.");
        const msg = `*ERRO LOCALIZA√á√ÉO - ALENCAS*‚ö†Ô∏è%0A%0Aüë§*Cliente:* ${document.getElementById('nome').value}%0Aüìç*End:* ${info}`;
        window.open(`https://wa.me/${WHATSAPP}?text=${msg}`);
        fecharModal();
    }

    function enviar() {
        const nome = document.getElementById('nome').value;
        const endereco = `${document.getElementById('rua').value}, ${document.getElementById('numero').value}`;
        const msg = `*NOVO FRETE - ALENCAS* üõµ%0A%0Aüë§*Cliente:* ${nome}%0Aüìè*Dist√¢ncia:* ${dFinal}%0Aüí∞*Valor:* R$ ${vFinal}%0Aüìç*End:* ${endereco}`;
        window.open(`https://wa.me/${WHATSAPP}?text=${msg}`);
    }
</script>
</body>
</html>
